<% const body=` 
    <div style="margin-bottom: 24px;">
        <h1 style="font-size: 32px; font-weight: 800; margin: 0 0 8px 0; letter-spacing: -.5px;">üìã Manage Items</h1>
        <p style="color: var(--muted); margin: 0; font-size: 16px;">Tambah, edit, filter, dan kelola inventory items</p>
    </div>

    <div class="card">
    <div style="display:flex; justify-content:space-between; gap:16px; flex-wrap:wrap; align-items:center; margin-bottom: 24px;">
        <div>
            <h3 style="margin:0; font-size: 20px;">Daftar Items</h3>
            <div class="sub">Total ${(items || []).length} item${(items || []).length !== 1 ? 's' : ''}</div>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <a class="btn primary" href="/items/new">‚ûï Tambah Item</a>
            <button class="btn" onclick="window.print()">üñ®Ô∏è Print</button>
            <button class="btn" onclick="downloadCSV()">üíæ Download CSV</button>
            <button class="btn" onclick="exportToExcel()">üìä Export Excel</button>
        </div>
    </div>

    <!-- Print Header (hanya muncul saat print) -->
    <div class="print-header" style="display: none;">
        <h2 style="text-align: center; margin: 0 0 8px 0;">LAPORAN KETERSEDIAAN OBAT DAN ALAT TROLI EMERGENCY</h2>
        <div id="print-datetime" style="text-align: center; font-size: 14px; color: #666; margin-bottom: 24px;"></div>
    </div>

    <form method="get" action="/items" class="form">
        <div class="row">
            <div class="field">
                <label>üîç Cari Nama Item</label>
                <input class="input" name="q" placeholder="Ketik nama item..." value="${q || ""}" />
            </div>
            <div class="field">
                <label style="font-size: 16px; font-weight: 700;">üìÇ Filter Kategori</label>
                <select class="input" name="category" style="font-size: 16px; font-weight: 600;">
                    <option value="">Semua kategori</option>
                    ${[
                        {val: "Drug", label: "üíä Drug"},
                        {val: "Circulation", label: "‚ù§Ô∏è Circulation"},
                        {val: "Airway", label: "ü´Å Airway"},
                        {val: "Breathing", label: "üí® Breathing"},
                        {val: "Fluid", label: "üíß Fluid"}
                    ].map(cat =>
                    `<option value="${cat.val}" ${category===cat.val ? "selected" :""}>${cat.label}</option>`
                    ).join("")}
                </select>
            </div>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="btn primary" type="submit">üîç Filter</button>
            <a class="btn" href="/items">üîÑ Reset</a>
        </div>
    </form>

    <div style="height:24px"></div>

    <div style="overflow-x: auto;">
    <table class="table">
        <thead>
            <tr>
                <th style="font-size: 16px; font-weight: 700;">üìÇ Kategori</th>
                <th>Nama Item</th>
                <th>Stok</th>
                <th>Min Stok</th>
                <th>Tanggal Expired</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            ${(items || []).length === 0 ? `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--muted);">
                        <div style="font-size: 48px; margin-bottom: 12px;">üì¶</div>
                        <div style="font-size: 16px; font-weight: 600;">Belum ada item</div>
                        <div style="font-size: 14px; margin-top: 8px;">Silakan tambah item baru untuk memulai</div>
                    </td>
                </tr>
            ` : (items || []).map(it => {
            const low = it.stock < it.minStock; const exp=it.expiredAt ? it.expiredAt.toISOString().slice(0,10) : "-" ;
            const catEmoji = {Drug: 'üíä', Circulation: '‚ù§Ô∏è', Airway: 'ü´Å', Breathing: 'üí®', Fluid: 'üíß'};
                return ` <tr>
                <td><span class="badge" style="font-size: 15px; font-weight: 700; padding: 8px 14px;">${catEmoji[it.category] || 'üì¶'} ${it.category}</span></td>  
                <td style="font-weight: 600;">${it.name}</td>
                <td>
                    <span style="font-weight: 600; color: ${low ? '#ff9090' : 'var(--ok)'};">${it.stock} ${it.unit}</span>
                    ${low ? `<span class="badge danger" style="margin-left: 8px;">‚ö†Ô∏è Low</span>` : ""}
                </td>
                <td style="color: var(--muted);">${it.minStock}</td>
                <td style="${it.expiredAt ? 'font-weight: 500;' : 'color: var(--muted);'}">${exp}</td>
                <td>
                    <div class="table-actions">
                        <a class="btn" href="/items/${it.id}/edit">‚úèÔ∏è Edit</a>
                        <form method="post" action="/items/${it.id}/delete" style="margin:0">
                            <button class="btn danger" onclick="return confirm('Yakin ingin menghapus item ini?')" type="submit">üóëÔ∏è Hapus</button>
                        </form>
                    </div>
                </td>
                </tr>`;
                }).join("")}
        </tbody>
    </table>
    </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script>
    // Set datetime untuk print header
    function setPrintDateTime() {
        const now = new Date();
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        const dayName = days[now.getDay()];
        const date = now.getDate();
        const month = months[now.getMonth()];
        const year = now.getFullYear();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        const datetime = dayName + ', ' + date + ' ' + month + ' ' + year + ' - Waktu ' + hours + '.' + minutes + ' WIB';
        document.getElementById('print-datetime').textContent = datetime;
    }

    // Fungsi download CSV
    function downloadCSV() {
        setPrintDateTime();
        const now = new Date();
        const items = ${JSON.stringify(items || [])};
        
        // Header CSV
        let csv = 'No,Kategori,Nama Obat,Jumlah Ketersediaan,Unit,Min Stock,Kadaluarsa\\n';
        
        // Data rows
        items.forEach((item, index) => {
            const exp = item.expiredAt ? new Date(item.expiredAt).toISOString().slice(0, 10) : '-';
            csv += (index + 1) + ',"' + item.category + '","' + item.name + '",' + 
                   item.stock + ',"' + item.unit + '",' + item.minStock + ',"' + exp + '"\\n';
        });
        
        // Create download
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        const filename = 'Laporan_Inventory_' + now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0') + '.csv';
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Set datetime saat halaman load dan sebelum print
    window.addEventListener('load', setPrintDateTime);
    window.addEventListener('beforeprint', setPrintDateTime);

    // Fungsi Export ke Excel dengan format sesuai gambar menggunakan ExcelJS
    async function exportToExcel() {
        const now = new Date();
        const items = ${JSON.stringify(items || [])};
        
        const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        const monthsShort = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
        
        const dayName = days[now.getDay()];
        const date = now.getDate();
        const month = months[now.getMonth()];
        const year = now.getFullYear();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        // Group items by category
        const categories = ['Drug', 'Circulation', 'Airway', 'Breathing', 'Fluid'];
        const groupedItems = {};
        categories.forEach(cat => {
            groupedItems[cat] = items.filter(item => item.category === cat);
        });
        
        // Format date untuk kadaluarsa (misal: 15-Jun-27)
        function formatExpDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const day = d.getDate();
            const monthStr = monthsShort[d.getMonth()];
            const yearStr = String(d.getFullYear()).slice(-2);
            return day + '-' + monthStr + '-' + yearStr;
        }
        
        // Create workbook with ExcelJS
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Laporan Inventory');
        
        // Set column widths
        worksheet.columns = [
            { width: 6 },   // A
            { width: 35 },  // B
            { width: 22 },  // C
            { width: 18 }   // D
        ];
        
        // Border style
        const thinBorder = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
        };
        
        // Row 1: Header title (merged A1:D1)
        worksheet.mergeCells('A1:D1');
        const headerCell = worksheet.getCell('A1');
        headerCell.value = 'LAPORAN KETERSEDIAAN OBAT DAN ALAT TROLI EMERGENCY';
        headerCell.font = { bold: true, size: 12, name: 'Arial' };
        headerCell.alignment = { horizontal: 'center', vertical: 'middle' };
        headerCell.border = thinBorder;
        
        // Apply border to merged cells
        ['B1', 'C1', 'D1'].forEach(addr => {
            worksheet.getCell(addr).border = thinBorder;
        });
        
        // Row 2: Date (merged C2:D2, right aligned)
        worksheet.mergeCells('C2:D2');
        const dateCell = worksheet.getCell('C2');
        dateCell.value = dayName + ', ' + date + ' ' + month + ' ' + year;
        dateCell.font = { bold: true, size: 10, name: 'Arial' };
        dateCell.alignment = { horizontal: 'right', vertical: 'middle' };
        dateCell.border = thinBorder;
        
        ['A2', 'B2', 'D2'].forEach(addr => {
            worksheet.getCell(addr).border = thinBorder;
        });
        
        // Row 3: Time (merged C3:D3, right aligned)
        worksheet.mergeCells('C3:D3');
        const timeCell = worksheet.getCell('C3');
        timeCell.value = 'Waktu ' + hours + '.' + minutes + ' WIB';
        timeCell.font = { bold: true, size: 10, name: 'Arial' };
        timeCell.alignment = { horizontal: 'right', vertical: 'middle' };
        timeCell.border = thinBorder;
        
        ['A3', 'B3', 'D3'].forEach(addr => {
            worksheet.getCell(addr).border = thinBorder;
        });
        
        let currentRow = 4;
        
        // Add data per category
        categories.forEach((category, catIndex) => {
            const categoryItems = groupedItems[category];
            
            // Category row
            const catRow = worksheet.getRow(currentRow);
            catRow.getCell(1).value = catIndex + 1;
            catRow.getCell(1).font = { bold: true, size: 10, name: 'Arial' };
            catRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
            catRow.getCell(1).border = thinBorder;
            
            catRow.getCell(2).value = category;
            catRow.getCell(2).font = { bold: true, size: 10, name: 'Arial' };
            catRow.getCell(2).alignment = { horizontal: 'left', vertical: 'middle' };
            catRow.getCell(2).border = thinBorder;
            
            catRow.getCell(3).border = thinBorder;
            catRow.getCell(4).border = thinBorder;
            currentRow++;
            
            // Sub-header row
            const subHeaderRow = worksheet.getRow(currentRow);
            subHeaderRow.getCell(1).border = thinBorder;
            
            subHeaderRow.getCell(2).value = 'Nama Obat';
            subHeaderRow.getCell(2).font = { bold: true, size: 10, name: 'Arial' };
            subHeaderRow.getCell(2).alignment = { horizontal: 'center', vertical: 'middle' };
            subHeaderRow.getCell(2).border = thinBorder;
            
            subHeaderRow.getCell(3).value = 'Jumlah Ketersediaan';
            subHeaderRow.getCell(3).font = { bold: true, size: 10, name: 'Arial' };
            subHeaderRow.getCell(3).alignment = { horizontal: 'center', vertical: 'middle' };
            subHeaderRow.getCell(3).border = thinBorder;
            
            subHeaderRow.getCell(4).value = 'Kadaluarsa';
            subHeaderRow.getCell(4).font = { bold: true, size: 10, name: 'Arial' };
            subHeaderRow.getCell(4).alignment = { horizontal: 'center', vertical: 'middle' };
            subHeaderRow.getCell(4).border = thinBorder;
            currentRow++;
            
            // Items rows
            if (categoryItems.length > 0) {
                categoryItems.forEach(item => {
                    const itemRow = worksheet.getRow(currentRow);
                    itemRow.getCell(1).border = thinBorder;
                    
                    itemRow.getCell(2).value = item.name;
                    itemRow.getCell(2).font = { size: 10, name: 'Arial' };
                    itemRow.getCell(2).alignment = { horizontal: 'left', vertical: 'middle' };
                    itemRow.getCell(2).border = thinBorder;
                    
                    itemRow.getCell(3).value = item.stock;
                    itemRow.getCell(3).font = { size: 10, name: 'Arial' };
                    itemRow.getCell(3).alignment = { horizontal: 'center', vertical: 'middle' };
                    itemRow.getCell(3).border = thinBorder;
                    
                    itemRow.getCell(4).value = formatExpDate(item.expiredAt);
                    itemRow.getCell(4).font = { size: 10, name: 'Arial' };
                    itemRow.getCell(4).alignment = { horizontal: 'center', vertical: 'middle' };
                    itemRow.getCell(4).border = thinBorder;
                    currentRow++;
                });
            } else {
                // Empty row with borders only
                const placeholderRow = worksheet.getRow(currentRow);
                placeholderRow.getCell(1).border = thinBorder;
                placeholderRow.getCell(2).border = thinBorder;
                placeholderRow.getCell(3).border = thinBorder;
                placeholderRow.getCell(4).border = thinBorder;
                currentRow++;
            }
        });
        
        // Generate filename
        const filename = 'Laporan_Inventory_' + now.getFullYear() + 
                        String(now.getMonth() + 1).padStart(2, '0') + 
                        String(now.getDate()).padStart(2, '0') + '_' +
                        String(now.getHours()).padStart(2, '0') + 
                        String(now.getMinutes()).padStart(2, '0') + '.xlsx';
        
        // Write to buffer and download
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }
    </script>
    `;
    %>
    <%- include("layout", { title: "Items" , body, user }) %>